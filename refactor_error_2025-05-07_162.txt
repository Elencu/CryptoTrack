Refactor error handling for bugfix (critical)
