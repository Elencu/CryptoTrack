Refactor payment processing for authentication (critical)
